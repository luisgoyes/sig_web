/**
 * This file contains x5engine.gallery360().
 * It creates a 360 degrees gallery.
 * See below for the function definition and the default params.
 *
 * @name gallery360.js
 * @author Claudio - Incomedia
 * @version 1.0.0b
 * @date October 11th, 2012
 * @category JavaScript image gallery
 * @copyright (c) 2012 Incomedia
 *//**
* Main gallery class
* @param The json object*/
window.gallery360=function(t){var e=$.extend({target:"",startFrom:0,media:[],width:400,height:400,guiColor:"#f7f7f7",guiAlpha:.999,backgroundColor:"#f7f7f7",helperBg:"black",swipeImage:"res/imSwipe.png",autoplay:!1,music:null,showButtons:!0,loaderCss:!1,controlBarHeight:28,controlBarImage:"",buttonPlayImage:"",buttonPauseImage:"",buttonNextImage:"",buttonPrevImage:"",resFolder:"res"},t);e.guiColor.indexOf("rgb") == 0&&(e.guiColor=x5engine.utils.rgb2hex(e.guiColor));var o=$(e.target),n=[],i=null,r=$("html").hasClass("touchevents"),a=navigator.userAgent.match(/Android/i),l=!1,u=null,s=null,c=null,d=null,g=null,h=null,p=null,f=null,m=0,b=x5engine.utils.hex2rgb(e.guiColor,-50,-50,-50),v=x5engine.utils.hex2rgb(e.guiColor,-20,-20,-20,!0),w=null,x=null,I=!1,B="autoplay_start",y="autoplay_stop",k=function(t,e,o,a){return null!==t&&void 0!==t&&null!==n[t]&&void 0!==n[t]&&(i!==t&&(null!==e&&void 0!==e||(e=!0),n[t].DOMObject().css("display","none"),null!==i&&void 0!==i?(n[i].DOMObject().after(n[t].DOMObject()),n[i].AnimateOut(j,function(t){t.DOMObject().detach()},o)):j.prepend(n[t].DOMObject()),n[i=t].AnimateIn(j,null,o),T.triggerHandler("showmedia"),void(r&&null!==w&&("false"==w.attr("data-hide")?w.attr("data-hide","true"):w.stop(!1,!1).fadeOut(),null!==x&&(clearTimeout(x),x=null),x=setTimeout(function(){w.stop(!1,!1).fadeIn()},7e3)))))},P=function(){var t=i;(++t>=n.length||null===n[t]||void 0===n[t])&&(t=0),k(t,(r||l)&&(null===c||void 0===c||"none"==c.css("display")))},C=function(){var t=i;(--t<0||null===n[t]||void 0===n[t])&&(t=n.length-1),k(t,(r||l)&&(null===c||void 0===c||"none"==c.css("display")),!0)},M=function(){return l||(l=!0,A(),T.trigger(B)),u=setTimeout(function(){P(),null!==u&&(clearTimeout(u),u=null),M()},n[i].AutoplayTime()),!0},O=function(){return H(),null!==u&&(clearTimeout(u),u=null,n[i].Stop()),l=!1,T.trigger(y),!0},A=function(){null!==Y&&Y.Play()},H=function(){null!==Y&&Y.Pause()},D=function(t){if(!(t>=e.media.length)){0===t&&(e.loaderCss?j.prepend(x5engine.settings.imLoadingAnimation):j.css({"background-image":"url('res/imLoad.gif')","background-position":"center center","background-repeat":"no-repeat"}));var o=n.length;new x5engine.mediaObject($.extend(e.media[t],{showControls:e.media[t].showControls||r,touchDevice:r,android:a,contentWidth:j.width(),contentHeight:j.height(),load:function(a){if(n[o]=a,t===e.media.length-1){if((!0===e.showButtons||"outside"===e.showButtons)&&!r){var l=m/(n.length-1);if(n.length<=20)for(var u=0;u<n.length;u++)f.append($("<div />").css({"background-color":b,position:"absolute",top:e.controlBarHeight/2-3,left:u*l}).width(1).height(6));f.on("dragstart",function(){return!1}).mousedown(function(){I=!0,O()}),$("body").mousemove(function(t){if(I){var e=Math.max(0,Math.min(m,t.pageX-f.offset().left));return e=Math.round(e/l),k(e),s.css("left",e*l),!1}}).mouseup(function(){I=!1}),T.on("showmedia",function(){s.css("left",i*l)})}e.loaderCss?j.find(".imLoadAnim").remove():j.css("background-image","none"),k(e.startFrom),!0===e.autoplay&&M()}if(r){var c=0,d=0,g=0,h=0,p=0,v=!1,w=null,x=e.width/e.media.length;n[o].BeforeMove(function(t){d=t.touches[0].pageX,g=t.touches[0].pageY,h=p=c=0,v=!1,w&&clearTimeout(w)}).Move(function(t,e){t.preventDefault();var o=Math.abs(e.offsetX)>Math.abs(e.offsetY)?e.offsetX:e.offsetY;o<c-x?(C(),c=o):o>c+x&&(P(),c=o),h=t.touches[0].pageX-d,p=t.touches[0].pageY-g,d=t.touches[0].pageX,g=t.touches[0].pageY,v=!0}).AfterMove(function(t,e){t.preventDefault(),(h=Math.max(Math.abs(h),Math.abs(p)))>5&&function t(o){v&&(e.offsetX<=0?C():P(),(o*=1.75)<500&&v&&(w=setTimeout(function(){t(o)},o)))}(100/Math.abs(h))})}D(t+1)},error:function(e,o){D(t+1)}}))}},T=$("<div />").css({position:"relative","background-color":e.backgroundColor,"user-select":"none"}).width(e.width).height(e.height).attr("unselectable","on"),j=$("<div />").css({overflow:"hidden",position:"absolute",left:0,top:0,"user-select":"none"}).width(e.width).height(e.height).attr("unselectable","on");if(T.append(j),o.empty().append(T),"static"==o.css("position")&&o.css("position","relative"),(!0===e.showButtons||"outside"===e.showButtons)&&!r){c=$("<div />").css({position:"absolute",top:"outside"==e.showButtons?j.height():"auto",bottom:"outside"==e.showButtons?"auto":0,left:0,right:0,"background-color":e.guiColor}).height(e.controlBarHeight),null===e.controlBarImage||void 0===e.controlBarImage||""===e.controlBarImage?c.css("background-image",x5engine.utils.cssPropertyPrefix("linear-gradient(bottom, "+x5engine.utils.hex2rgb(e.guiColor,-50,-50,-50,!0)+" 0%, "+e.guiColor+" 50%, "+x5engine.utils.hex2rgb(e.guiColor,50,50,50,!0)+" 100%)")):c.css("background-image",""!==e.controlBarImage&&void 0!==e.controlBarImage&&null!==e.controlBarImage?"url('"+e.controlBarImage+"')":"none"),"outside"===e.showButtons?j.after(c):j.append(c);var X=function(){var t=null;""===e.buttonPlayImage||void 0===e.buttonPlayImage||null===e.buttonPlayImage?(t=$("<div />").css({"background-color":"transparent","border-style":"solid"}),l?t.css({position:"static",margin:(d.height()-16)/2+"px "+d.height()/3+"px","border-width":"0 3px 0 3px","border-color":b,"border-radius":0}).width(4).height(16):t.css({margin:(d.height()-20)/2+"px "+d.height()/3+"px","border-width":10,"border-color":"transparent transparent transparent "+b,"border-radius":3}).width(1).height(1)):t=$("<img />").attr("src",l?e.buttonPauseImage:e.buttonPlayImage),d.empty().append(t)};(d=null===e.buttonPlayImage||void 0===e.buttonPlayImage||""===e.buttonPlayImage?$("<div />").css({float:"left",cursor:"pointer","border-right":"1px solid "+v}).width(e.controlBarHeight-1).height(e.controlBarHeight):$("<div />").attr("src",e.buttonPlayImage).css({float:"left",cursor:"pointer"})).click(function(t){t.preventDefault(),l?O():M()}),X(),T.on(B,X).on(y,X),c.append(d),c.append(g=$("<div />").css({float:"right","border-left":"1px solid "+v,"text-align":"center"})),p=""===e.buttonPrevImage||null===e.buttonPrevImage||void 0===e.buttonPrevImage?$("<div />").css({color:b,cursor:"pointer","line-height":e.controlBarHeight+"px","font-size":e.controlBarHeight-5,"font-family":"Arial",float:"left",padding:"0 5px 0 5px"}).html("<"):$("<img />").attr("src",e.buttonPrevImage).css("cursor","pointer"),g.prepend(p.click(function(t){return t.preventDefault(),O(),C(),!1}).on("selectstart mousedown",function(){return!1})),h=""===e.buttonNextImage||null===e.buttonNextImage||void 0===e.buttonNextImage?$("<div />").css({color:b,cursor:"pointer","line-height":e.controlBarHeight+"px","font-size":e.controlBarHeight-5,"font-family":"Arial",float:"right",padding:"0 5px 0 5px"}).html(">"):$("<img />").attr("src",e.buttonNextImage).css({cursor:"pointer"}),g.append(h.click(function(t){return t.preventDefault(),O(),P(),!1}).on("selectstart mousedown",function(){return!1})),m=e.width-d.outerWidth()-g.outerWidth()-20,s=$("<div >").css({"background-color":b,position:"absolute",top:-9}).width(8).height(20),f=$("<div >").css({position:"relative",float:"left",cursor:"pointer",margin:"0 10px"}).width(m).append($("<div />").css({position:"absolute",top:e.controlBarHeight/2-1,"background-color":b,width:"100%",height:2}).append(s)),d.after(f);var N=function(){j.triggerHandler("mouseleave")};c.fadeOut(0),"outside"!=e.showButtons&&j.mouseenter(function(){$("body").off("mouseup",N),c.stop(!1,!1).fadeTo(250,e.guiAlpha)}).mouseleave(function(){I?$("body").one("mouseup",N):c.stop(!1,!1).fadeOut(250)})}r&&(w=$('<div data-hide="false" />').css({position:"absolute",bottom:0,right:0}).width(30).height(30).append($("<div />").css({background:e.helperBg,"border-top-left-radius":5,position:"absolute",top:0,bottom:0,left:0,right:0}).fadeTo(0,.75)).append($("<div />").css({background:"transparent url('"+e.swipeImage+"') no-repeat center center",position:"absolute",top:0,bottom:0,left:0,right:0})),j.append(w));var Y=null;return null!==e.music&&void 0!==e.music&&(Y=new x5engine.mediaObject({type:"audio",url:e.music,width:1,height:1,effect:"none",load:function(t){T.append(t.DOMObject()),t.AnimateIn()}})),D(0),{currentItemIndex:function(){return i}}};